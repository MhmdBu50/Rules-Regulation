@model RulesRegulation.Controllers.ReportViewModel

@{
    ViewData["Title"] = "Analytics Dashboard";
}

@section Styles {
    <link rel="stylesheet" href="~/css/reportPage.css">
    <link rel="stylesheet" href="~/css/AdminPage.css">
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="~/js/reportPage.js"></script>
}

<!-- Header Section -->
<header class="report-header">
    <div class="container-fluid">
        <div class="row align-items-center justify-content-between">
            <div class="col-auto">
                <button class="back-btn" onclick="goBack()">
                    <i class="fas fa-arrow-left me-2"></i>Back to Admin
                </button>
            </div>
            <div class="col-auto text-center">
                <h1 class="report-title">
                    <i class="fas fa-chart-line me-3"></i>Analytics Dashboard
                </h1>
                <p class="report-subtitle">Comprehensive system statistics and insights</p>
            </div>
            <div class="col-auto">
                <button class="export-pdf-btn" onclick="exportToPDF()">
                    <i class="fas fa-file-pdf me-2"></i>Export PDF
                </button>
            </div>
        </div>
    </div>
</header>

<!-- Success/Error Messages -->
<div class="container mt-3">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
</div>

<div id="reportContent" class="report-content">
    <!-- Overview Statistics Cards -->
    <div class="container-fluid mb-5">
        <div class="row g-4">
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="stat-card stat-card-blue">
                    <div class="stat-icon">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stat-content">
                        <h3>@Model.TotalDocuments</h3>
                        <p>Total Documents</p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="stat-card stat-card-green">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <h3>@Model.TotalUsers</h3>
                        <p>Registered Users</p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="stat-card stat-card-orange" data-stat="downloads">
                    <div class="stat-icon">
                        <i class="fas fa-download"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">@Model.TotalDownloads</h3>
                        <p>Total Downloads</p>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="stat-card stat-card-purple" data-stat="views">
                    <div class="stat-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">@Model.TotalViews</h3>
                        <p>Total Views</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="container-fluid mb-5">
        <div class="row g-4">
            <!-- Line Chart: Views & Downloads over Time -->
            <div class="col-12 col-lg-6">
                <div class="chart-container">
                    <div class="chart-header">
                        <h4><i class="fas fa-chart-line me-2"></i>Views & Downloads over Time</h4>
                    </div>
                    <div class="chart-body">
                        <canvas id="viewsDownloadsChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- Bar Chart: Top 5 Most Viewed Records -->
            <div class="col-12 col-lg-6">
                <div class="chart-container">
                    <div class="chart-header">
                        <h4><i class="fas fa-chart-bar me-2"></i>Top 5 Most Viewed Records</h4>
                    </div>
                    <div class="chart-body">
                        <canvas id="topRecordsChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- Bar Chart: Top 5 Most Downloaded Records -->
            <div class="col-12 col-lg-6">
                <div class="chart-container">
                    <div class="chart-header">
                        <h4><i class="fas fa-download me-2"></i>Top 5 Most Downloaded Records</h4>
                    </div>
                    <div class="chart-body">
                        <canvas id="topDownloadsChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- Pie Chart: Document Type Distribution -->
            <div class="col-12 col-lg-6">
                <div class="chart-container">
                    <div class="chart-header">
                        <h4><i class="fas fa-chart-pie me-2"></i>Document Type Distribution</h4>
                    </div>
                    <div class="chart-body">
                        <canvas id="documentTypeChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Documents Section -->
    <div class="container-fluid mb-5">
        <div class="row g-4">
            <!-- Top Downloaded -->
            <div class="col-12 col-lg-4">
                <div class="top-list-container">
                    <div class="top-list-header">
                        <h5><i class="fas fa-download me-2 text-success"></i>Top Downloaded</h5>
                    </div>
                    <div class="top-list-body">
                        @if (Model.TopDownloaded.Any())
                        {
                            @for (int i = 0; i < Model.TopDownloaded.Take(5).Count(); i++)
                            {
                                var doc = Model.TopDownloaded.Skip(i).First();
                                <div class="top-item">
                                    <div class="ranking-badge ranking-@(i + 1)">
                                        @(i + 1)
                                    </div>
                                    <div class="top-item-content">
                                        <span class="top-item-name" title="@doc.RegulationName">@doc.RegulationName</span>
                                        <span class="top-item-count">@doc.Count downloads</span>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="no-data">No download data available</div>
                        }
                    </div>
                </div>
            </div>

            <!-- Top Viewed -->
            <div class="col-12 col-lg-4">
                <div class="top-list-container">
                    <div class="top-list-header">
                        <h5><i class="fas fa-eye me-2 text-info"></i>Top Viewed</h5>
                    </div>
                    <div class="top-list-body">
                        @if (Model.TopViewed.Any())
                        {
                            @for (int i = 0; i < Model.TopViewed.Take(5).Count(); i++)
                            {
                                var doc = Model.TopViewed.Skip(i).First();
                                <div class="top-item">
                                    <div class="ranking-badge ranking-@(i + 1)">
                                        @(i + 1)
                                    </div>
                                    <div class="top-item-content">
                                        <span class="top-item-name" title="@doc.RegulationName">@doc.RegulationName</span>
                                        <span class="top-item-count">@doc.Count views</span>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="no-data">No view data available</div>
                        }
                    </div>
                </div>
            </div>

            <!-- Most Details Shown -->
            <div class="col-12 col-lg-4">
                <div class="top-list-container">
                    <div class="top-list-header">
                        <h5><i class="fas fa-info-circle me-2 text-warning"></i>Most Details Shown</h5>
                    </div>
                    <div class="top-list-body">
                        @if (Model.MostDetailsShown.Any())
                        {
                            @for (int i = 0; i < Model.MostDetailsShown.Take(5).Count(); i++)
                            {
                                var doc = Model.MostDetailsShown.Skip(i).First();
                                <div class="top-item">
                                    <div class="ranking-badge ranking-@(i + 1)">
                                        @(i + 1)
                                    </div>
                                    <div class="top-item-content">
                                        <span class="top-item-name" title="@doc.RegulationName">@doc.RegulationName</span>
                                        <span class="top-item-count">@doc.Count details</span>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="no-data">No details data available</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Statistics Table -->
    <div class="container-fluid">
        <div class="table-section">
            <div class="table-header">
                <div class="row align-items-center">
                    <div class="col-12 col-md-6">
                        <h4><i class="fas fa-table me-2"></i>Document Statistics</h4>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="table-controls">
                            <select id="sortSelect" class="form-select">
                                <option value="totalInteractions">Sort by Total Interactions</option>
                                <option value="downloads">Sort by Downloads</option>
                                <option value="views">Sort by Views</option>
                                <option value="details">Sort by Details Shown</option>
                                <option value="name">Sort by Name</option>
                                <option value="type">Sort by Document Type</option>
                            </select>
                            <select id="filterSelect" class="form-select ms-2">
                                <option value="">All Document Types</option>
                                @foreach (var docType in Model.DocumentTypeDistribution)
                                {
                                    <option value="@docType.DocumentType">@docType.DocumentType</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="table-body">
                <div class="table-responsive">
                    <table id="documentsTable" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Record ID</th>
                                <th>Document Name</th>
                                <th>Type</th>
                                <th>Department</th>
                                <th>Downloads</th>
                                <th>Views</th>
                                <th>Details</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var doc in Model.DocumentStats)
                            {
                                <tr data-type="@doc.DocumentType" data-downloads="@doc.DownloadCount" data-views="@doc.ViewCount" data-details="@doc.DetailsCount" data-total="@doc.TotalInteractions" data-name="@doc.RegulationName">
                                    <td><span class="badge bg-secondary">@doc.RecordId</span></td>
                                    <td class="document-name" title="@doc.RegulationName">@doc.RegulationName</td>
                                    <td>@doc.DocumentType</td>
                                    <td>@doc.Department</td>
                                    <td><span class="badge bg-success">@doc.DownloadCount</span></td>
                                    <td><span class="badge bg-info">@doc.ViewCount</span></td>
                                    <td><span class="badge bg-warning">@doc.DetailsCount</span></td>
                                    <td><span class="badge bg-primary">@doc.TotalInteractions</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<script type="application/json" id="chartData">
{
    "documentTypes": @Html.Raw(Json.Serialize(Model.DocumentTypeDistribution.Select(d => new { label = d.DocumentType, value = d.Count, percentage = d.Percentage }))),
    "monthlyStats": @Html.Raw(Json.Serialize(Model.MonthlyStats.Select(m => new { 
        month = m.MonthYear, 
        downloads = m.Downloads, 
        views = m.Views, 
        details = m.DetailsShown, 
        total = m.TotalActions,
        uniqueUsers = m.UniqueUsers 
    }))),
    "monthlyChartData": @Html.Raw(Json.Serialize(Model.MonthlyChartData.Select(m => new {
        monthYear = m.MonthYear,
        views = m.Views,
        downloads = m.Downloads
    }))),
    "topRecordsData": @Html.Raw(Json.Serialize(Model.TopRecordsChartData.Select(r => new {
        recordId = r.RecordId,
        title = r.Title,
        viewCount = r.ViewCount
    }))),
    "topDownloadsData": @Html.Raw(Json.Serialize(Model.TopDownloadsChartData.Select(d => new {
        recordId = d.RecordId,
        title = d.Title,
        downloadCount = d.DownloadCount
    })))
}
</script>
