@model RulesRegulation.Controllers.ReportViewModel
@using Microsoft.AspNetCore.Localization

@{
    ViewData["Title"] = "Analytics Dashboard";
    var requestCulture = Context.Features.Get<IRequestCultureFeature>();
    var currentCulture = requestCulture?.RequestCulture.Culture.Name ?? "en-US";
    var isArabic = currentCulture == "ar-SA";
}

@functions {
    private string GetDocumentTypeTranslation(string documentType)
    {
        return documentType switch
        {
            "Student guides & templates" => "أدلة ونماذج الطلاب",
            "Student rules & regulations" => "قواعد وأنظمة الطلاب",
           "Employees’ rules & regulations" => "قواعد وأنظمة الموظفين",
            "Academic rules & regulations" => "قواعد وأنظمة أكاديمية",
            _ => documentType ?? ""
        };
    }
    
    private string GetDepartmentTranslation(string department)
    {
        return department switch
        {
            "Reg and Admission" => "التسجيل والقبول",
            "CCSIT" => "كلية علوم الحاسب وتقنية المعلومات",
            "Communication and tech" => "الاتصالات والتقنية",
            "Hospital" => "المستشفى",
            "Library" => "المكتبة",
            "Students Affairs" => "شؤون الطلاب",
            "Preparetory" => "السنة التحضيرية",
            "Academic Affairs" => "الشؤون الأكاديمية",
            _ => department ?? ""
        };
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/reportPage.css">
    <link rel="stylesheet" href="~/css/AdminPage.css">
    <link rel="stylesheet" href="~/css/_rtl_Styles.css" />
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="~/js/reportPage.js"></script>
    <script src="~/js/languageSwitcher.js"></script>
}

<!-- Header Section -->
<header class="report-header">
    <div class="container-fluid">
        <div class="row align-items-center justify-content-between">
            <div class="col-auto">
                <button class="back-btn" onclick="goBack()">
                    <span class="fas fa-arrow-left me-2" id="btn-back-admin"></span>
                </button>
            </div>
            <div class="col-auto text-center">
                <h1 class="report-title">
                    <span class="fas fa-chart-line me-3" id= "dashboard-title"></span>
                </h1>
                <!-- Comprehensive system statistics and insights -->
                <p class="report-subtitle" id="dashboard-subtitle"></p>
            </div>
            <div class="col-auto">
                <button class="export-pdf-btn" onclick="exportToPDF()">
                    <span class="fas fa-file-pdf me-2" id="btn-export-pdf"></span>
                </button>
            </div>
        </div>
    </div>
</header>

<!-- Success/Error Messages -->
<div class="container mt-3">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
</div>

<div id="reportContent" class="report-content">
    <!-- Overview Statistics Cards -->
    <div class="container-fluid mb-5">
        <div class="row g-4">
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="stat-card stat-card-one d-flex align-items-center justify-content-between">
                    
                    <div class="stat-content">
                        <!-- Total Documents -->
                        <p id="stat-total-documents"></p>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-file-alt"></i>
                        <span class="stat-number-overlay">@Model.TotalDocuments</span>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="stat-card stat-card-two d-flex align-items-center justify-content-between">
                    <div class="stat-content">
                        <!--Registered Users-->
                        <p id="stat-total-users"></p>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                        <span class="stat-number-overlay">@Model.TotalUsers</span>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="stat-card stat-card-three d-flex align-items-center justify-content-between" data-stat="downloads">
                    <div class="stat-content">
                        <!-- Total Downloads -->
                        <p id="stat-total-downloads"></p>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-download"></i>
                        <span class="stat-number-overlay">@Model.TotalDownloads</span>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="stat-card stat-card-four d-flex align-items-center justify-content-between" data-stat="views">
                    <div class="stat-content">
                        <!-- Total Views -->
                        <p id="stat-total-views"></p>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-eye"></i>
                        <span class="stat-number-overlay">@Model.TotalViews</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="container-fluid mb-5">
        <div class="row g-4">
            <!-- Line Chart: Views & Downloads over Time -->
            <div class="col-12 col-lg-6">
                <div class="chart-container">
                    <div class="chart-header">
                        <!-- views & Downloads over Time -->
                        <h4><span class="fas fa-chart-line me-2" id="chart-views-downloads"></span></h4>
                    </div>
                    <div class="chart-body">
                        <canvas id="viewsDownloadsChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- Pie Chart: Document Type Distribution -->
            <div class="col-12 col-lg-6">
                <div class="chart-container">
                    <div class="chart-header">
                        <!-- Document Type Distribution -->
                        <h4><span class="fas fa-chart-pie me-2" id="chart-type-distribution"></span></h4>
                    </div>
                    <div class="chart-body">
                        <!-- Document Type Distribution Chart -->
                        <canvas id="documentTypeChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- Bar Chart: Top 5 Most Downloaded Records -->
            <div class="col-12 col-lg-6">
                <div class="chart-container">
                    <div class="chart-header">
                        <!-- Top 5 Most Downloaded Records -->
                        <h4><span class="fas fa-download me-2" id="chart-top-downloaded"></span></h4>
                    </div>
                    <div class="chart-body">
                        <canvas id="topDownloadsChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- Bar Chart: Top 5 Most Viewed Records -->
            <div class="col-12 col-lg-6">
                <div class="chart-container">
                    <div class="chart-header">
                        <!-- Top 5 Most Viewed Records -->  
                        <h4><span class="fas fa-chart-bar me-2" id="chart-top-viewed"></span></h4>
                    </div>
                    <div class="chart-body">
                        <canvas id="topRecordsChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Top Documents Section -->
    <div class="container-fluid mb-5">
        <div class="row g-4">
            <!-- Top Downloaded -->
            <div class="col-12 col-lg-4">
                <div class="top-list-container">
                    <div class="top-list-header">
                        <h5><span class="fas fa-download me-2 text-success" id="list-top-downloaded"></span></h5>
                    </div>
                    <div class="top-list-body">
                        <!-- No download data available message -->
                        @if (Model.TopDownloaded.Any())
                        {
                            @for (int i = 0; i < Model.TopDownloaded.Take(5).Count(); i++)
                            {
                                var doc = Model.TopDownloaded.Skip(i).First();
                                
                                // Use Arabic name if available and language is Arabic
                                var displayName = isArabic && !string.IsNullOrEmpty(doc.RegulationNameAr) 
                                    ? doc.RegulationNameAr 
                                    : doc.RegulationName;
                                
                                <div class="top-item">
                                    <div class="ranking-badge ranking-@(i + 1)">
                                        @(i + 1)
                                    </div>
                                    <div class="top-item-content">
                                        <span class="top-item-name" title="@displayName">@displayName</span>
                                        <span class="top-item-count">@doc.Count @(isArabic ? "التنزيلات" : "downloads")</span>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="no-data" id="msg-no-download-data"></div>
                        }
                    </div>
                </div>
            </div>

            <!-- Top Viewed -->
            <div class="col-12 col-lg-4">
                <div class="top-list-container">
                    <div class="top-list-header">
                        <h5><span class="fas fa-eye me-2 text-info" id="list-top-viewed"></span></h5>
                    </div>
                    <div class="top-list-body">
                        <!-- No view data available message -->
                        @if (Model.TopViewed.Any())
                        {
                            @for (int i = 0; i < Model.TopViewed.Take(5).Count(); i++)
                            {
                                var doc = Model.TopViewed.Skip(i).First();
                                
                                // Use Arabic name if available and language is Arabic
                                var displayName = isArabic && !string.IsNullOrEmpty(doc.RegulationNameAr) 
                                    ? doc.RegulationNameAr 
                                    : doc.RegulationName;
                                
                                <div class="top-item">
                                    <div class="ranking-badge ranking-@(i + 1)">
                                        @(i + 1)
                                    </div>
                                    <div class="top-item-content">
                                        <span class="top-item-name" title="@displayName">@displayName</span>
                                        <span class="top-item-count">@doc.Count @(isArabic ? "المشاهدات" : "views")</span>
                                    </div>
                                </div>
                            }
                        }
                        else
                        
                        {
                            <div class="no-data" id="msg-no-view-data"></div>
                        }
                    </div>
                </div>
            </div>

            <!-- Most Details Shown -->
            <div class="col-12 col-lg-4">
                <div class="top-list-container">
                    <div class="top-list-header">
                        <h5><span class="fas fa-info-circle me-2 text-warning" id="list-most-details"></span></h5>
                    </div>
                    <div class="top-list-body">
                        <!-- No details data available message -->
                        @if (Model.MostDetailsShown.Any())
                        {
                            @for (int i = 0; i < Model.MostDetailsShown.Take(5).Count(); i++)
                            {
                                var doc = Model.MostDetailsShown.Skip(i).First();
                                
                                // Use Arabic name if available and language is Arabic
                                var displayName = isArabic && !string.IsNullOrEmpty(doc.RegulationNameAr) 
                                    ? doc.RegulationNameAr 
                                    : doc.RegulationName;
                                
                                <div class="top-item">
                                    <div class="ranking-badge ranking-@(i + 1)">
                                        @(i + 1)
                                    </div>
                                    <div class="top-item-content">
                                        <span class="top-item-name" title="@displayName">@displayName</span>
                                        <span class="top-item-count">@doc.Count @(isArabic ? "التفاصيل" : "details")</span>
                                    </div>
                                </div>
                            }
                        }
                        
                        else
                        
                        {
                            <div class="no-data" id="msg-no-details-data"></div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Statistics Table -->
    <div class="container-fluid">
        <div class="table-section">
            <div class="table-header">
                <div class="row align-items-center">
                    <div class="col-12 col-md-6">
                        <h4><span class="fas fa-table me-2" id="table-title"></span></h4>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="table-controls">
                            <select id="sortSelect" class="form-select">
                                <!-- Sort by Total Interactions -->
                                <option value="totalInteractions" id="sort-total"></option>
                                <!-- Sort by Downloads, Views, Details, Name, Type -->
                                <option value="downloads" id="sort-downloads"></option>
                                <option value="views" id= "sort-views"></option>
                                <option value="details" id="sort-details"></option>
                                <option value="name" id="sort-name"></option>
                                <option value="type" id="sort-type"></option>
                            </select>
                            <select id="filterSelect" class="form-select ms-2">
                                <!-- All Document Types -->
                                <option value="" id="filter-all-types"></option>
                                @foreach (var docType in Model.DocumentTypeDistribution)
                                {
                                    var displayType = isArabic ? GetDocumentTypeTranslation(docType.DocumentType) : docType.DocumentType;
                                    <option value="@docType.DocumentType">@displayType</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="table-body">
                <div class="table-responsive">
                    <table id="documentsTable" class="table table-striped table-hover">
                        <thead>
                         <!--   Record ID Document Name TypeDepartment Downloads Views Details Total -->
                            <tr>
                                <th id="th-record-id"></th>
                                <th id="th-doc-name"></th>
                                <th id="th-type"></th>
                                <th id="th-department"></th>
                                <th id="th-downloads"></th>
                                <th id="th-views"></th>
                                <th id="th-details"></th>
                                <th id="th-total"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var doc in Model.DocumentStats)
                            {
                                var displayName = isArabic && !string.IsNullOrEmpty(doc.RegulationNameAr) 
                                    ? doc.RegulationNameAr 
                                    : doc.RegulationName;
                                
                                var displayType = isArabic ? GetDocumentTypeTranslation(doc.DocumentType) : doc.DocumentType;
                                var displayDepartment = isArabic ? GetDepartmentTranslation(doc.Department) : doc.Department;

                                <tr data-type="@doc.DocumentType" data-downloads="@doc.DownloadCount" data-views="@doc.ViewCount" data-details="@doc.DetailsCount" data-total="@doc.TotalInteractions" data-name="@doc.RegulationName">
                                    <td><span class="badge bg-secondary">@doc.RecordId</span></td>
                                    <td class="document-name" title="@displayName">@displayName</td>
                                    <td>@displayType</td>
                                    <td>@displayDepartment</td>
                                    <td><span class="badge bg-success">@doc.DownloadCount</span></td>
                                    <td><span class="badge bg-info">@doc.ViewCount</span></td>
                                    <td><span class="badge bg-warning">@doc.DetailsCount</span></td>
                                    <td><span class="badge bg-primary">@doc.TotalInteractions</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<script type="application/json" id="chartData">
{
    "isArabic": @(isArabic.ToString().ToLower()),
    "documentTypes": @Html.Raw(Json.Serialize(Model.DocumentTypeDistribution.Select(d => new { 
        label = isArabic ? GetDocumentTypeTranslation(d.DocumentType) : d.DocumentType, 
        value = d.Count, 
        percentage = d.Percentage 
    }))),
    "monthlyStats": @Html.Raw(Json.Serialize(Model.MonthlyStats.Select(m => new { 
        month = m.MonthYear, 
        downloads = m.Downloads, 
        views = m.Views, 
        details = m.DetailsShown, 
        total = m.TotalActions,
        uniqueUsers = m.UniqueUsers 
    }))),
    "monthlyChartData": @Html.Raw(Json.Serialize(Model.MonthlyChartData.Select(m => new {
        monthYear = m.MonthYear,
        views = m.Views,
        downloads = m.Downloads
    }))),
    "topRecordsData": @Html.Raw(Json.Serialize(Model.TopRecordsChartData.Select(r => new {
        recordId = r.RecordId,
        title = (isArabic && !string.IsNullOrEmpty(r.TitleAr)) ? r.TitleAr : r.Title,
        viewCount = r.ViewCount
    }))),
    "topDownloadsData": @Html.Raw(Json.Serialize(Model.TopDownloadsChartData.Select(d => new {
        recordId = d.RecordId,
        title = (isArabic && !string.IsNullOrEmpty(d.TitleAr)) ? d.TitleAr : d.Title,
        downloadCount = d.DownloadCount
    })))
}
</script>
